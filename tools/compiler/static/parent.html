<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parent</title>
</head>
<body>
<div>

    <textarea id="codeInput" style="width: 400px;height: 500px">
        onStart => {
            flag := true
            for flag {
                onMsg "die", => {
                    flag = false
                }
                glide -877, 180, 3
                setXYpos -240, 180
            }
        }
    </textarea>

    <div>

    </div>

    <button onclick="runTypesInfo()">runTypesInfo</button>
    <button onclick="runCodeDiagnostics()">runCodeDiagnostics</button>
    <button onclick="runCodeInlayHint()">runCodeInlayHint</button>

    <div id="compiler-iframe-container">
    </div>
</div>


<script>
    const container = document.getElementById("compiler-iframe-container")
    let currentIframe = 1
    createIframe()

    function createIframe() {
        const iframe = document.createElement("iframe")
        iframe.id = "compiler-iframe" + currentIframe
        iframe.width = 0
        iframe.height = 0
        currentIframe++
        iframe.src = "index.html"
        container.appendChild(iframe)
    }

    function reloadIframe() {
        const iframe = getIframe()
        if (iframe) {
            iframe.contentWindow.location.reload()
        }
    }

    function getIframe() {
        return document.getElementById("compiler-iframe-container").children[0]
    }

    window.addEventListener("message", function (event) {
        if (event.origin !== window.location.origin) {
            return;
        }

        var data = event.data
        if (data.level === "log") {
            if (data.log[0] && data.log[0].includes("goroutine ")) {
                reloadIframe()
            }
            console.log(data)
        }

    })

    function runTypesInfo() {
        try {
            let res = getIframe().contentWindow.getTypes({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }

    }

    function runCodeDiagnostics() {
        try {
            let res = getIframe().contentWindow.getDiagnostics({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }
    }


    function runCodeInlayHint() {
        getIframe().contentWindow.postMessage({
            f: "getInlayHints",
            info: "wasm",
            in: {
                name: "test.spx",
                code: document.getElementById("codeInput").value
            }
        }, window.location.origin)
    }

</script>

</body>
</html>