<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parent</title>
</head>
<body>
<div>

    <textarea id="codeInput" style="width: 400px;height: 500px">
var a int

var this bool

func add(a,b int) int {
    a = a + 1
    c := 1
    return a + b + c
}

onStart => {
    play "sound1"
    flag := true
    sum := add(1,2)
    test.move 10
    println "hi"
    sum = 3
    a = 2
    for flag {
        onMsg "die", => {
            flag = false
        }
        glide -877, 180, 3
        setXYpos -240, 180
    }

	myFn := func() {

    }
    myFn()
}

    </textarea>

    <input type="number" id="line" value="8" >

    </input>

    <div>

    </div>

    <button onclick="runTypesInfo()">runTypesInfo</button>
    <button onclick="runCodeDiagnostics()">runCodeDiagnostics</button>
    <button onclick="runDefinition()">runDefinition</button>
    <button onclick="runInlayHint()">runInlayHints</button>
    <br>
    <button onclick="runCompletion()">runCompletion</button>


    <div id="compiler-iframe-container">
    </div>
</div>


<script>
    const container = document.getElementById("compiler-iframe-container")
    createIframe()

    function createIframe() {
        const iframe = document.createElement("iframe")
        iframe.id = "compiler-iframe"
        iframe.width = 0
        iframe.height = 0
        iframe.src = "index.html"
        container.appendChild(iframe)
    }

    function reloadIframe() {
        const iframe = getIframe()
        if (iframe) {
            iframe.contentWindow.location.reload()
        }
    }

    function getIframe() {
        return document.getElementById("compiler-iframe-container").children[0]
    }

    window.addEventListener("message", function (event) {
        if (event.origin !== window.location.origin) {
            return;
        }

        var data = event.data
        if (data.level === "log") {
            if (data.log[0] && data.log[0].includes("goroutine ")) {
                // need to report detail for analyse
                reloadIframe()
            }
            console.log(data)
        }

    })

    function runTypesInfo() {
        try {
            let res = getIframe().contentWindow.getTypes({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }
    }

    function runCodeDiagnostics() {
        try {
            let res = getIframe().contentWindow.getDiagnostics({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }
    }


    function runDefinition() {
        try {
            let res = getIframe().contentWindow.getDefinition({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }
    }

    function runInlayHint() {
        try {
            let res = getIframe().contentWindow.getInlayHints({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }
    }

    function runCompletion() {
        try {
            let res = getIframe().contentWindow.getCompletionItems({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value,
                    line: Number(document.getElementById("line").value)
                }
            })
            console.log(res)
        } catch (e) {
            console.error(e)
        }
    }

</script>

</body>
</html>