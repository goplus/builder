<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parent</title>
</head>
<body>
<div>

    <textarea id="codeInput" style="width: 400px;height: 500px">
var (
    x int
    y int
)

var a int
var b int
var c int

func add(a,b int) int {
    a = a + 1
    c := 1
    return a + b + c
}

type sA struct{
    sC sC
    sD
    sP *sP
}

type sC struct{
    ca int
    cb int
}

type sD struct{
    da int
    db int
}

type sP struct{
    pa int
    pb int
}

onStart => {
    varBlockA01 = 1
    varBlockB01 = 1
    varBlockC01 = 1
    normalVar01 = 1
    Hi()
    t.x = 1
    play "sound1"
    flag := true
    sum := add(1,2)
    test.move 10
    println "hi"
    sum = 3
    a = 2
    for flag {
        onMsg "die", => {
            flag = false
        }
        glide -877, 180, 3
        setXYpos -240, 180
    }

	myFn := func() {

    }
    myFn()
}
    </textarea>

    <textarea id="mainCode" style="width: 400px;height: 100px">
var (
    varBlockA01 int
    varBlockA02 int
)

var (
    varBlockB01 int
    varBlockB02 int
)

var (
    varBlockC01 int
    varBlockC02 int
)

var normalVar01 int

var t *test

func Hi() string {
    return "Hi"
}
    </textarea>

    <br>
    行
    <input type="number" id="line" value="8" >

    </input>
    列
    <input type="number" id="column" value="8" >

    </input>

    <br>

    <input type="text" id="token" value="step"/>

    <br>

    <button onclick="runTypesInfo()">runTypesInfo</button>
    <button onclick="runCodeDiagnostics()">runCodeDiagnostics</button>
    <button onclick="runDefinition()">runDefinition</button>
    <br>
    <button onclick="runInlayHint()">runInlayHints</button>
    <button onclick="runCompletion()">runCompletion</button>
    <button onclick="runTokenDetail()">runTokenDetail</button>
    <br>
    <button onclick="runTokensDetail()">runTokensDetail</button>


    <div id="compiler-iframe-container">
    </div>
</div>


<script>
    const container = document.getElementById("compiler-iframe-container")
    createIframe()

    function createIframe() {
        const iframe = document.createElement("iframe")
        iframe.id = "compiler-iframe"
        iframe.width = 0
        iframe.height = 0
        iframe.src = "index.html"
        container.appendChild(iframe)
    }

    function reloadIframe() {
        const iframe = getIframe()
        if (iframe) {
            iframe.contentWindow.location.reload()
        }
    }

    function getIframe() {
        return document.getElementById("compiler-iframe-container").firstElementChild
    }

    window.addEventListener("message", function (event) {
        if (event.origin !== window.location.origin) {
            return;
        }

        var data = event.data
        if (data.level === "log") {
            if (data.log[0] && data.log[0].includes("goroutine ")) {
                // need to report detail for analyse
                reloadIframe()
            }
            console.log(data)
        }

    })

    function runTypesInfo() {
        try {
            let res = getIframe().contentWindow.getTypes({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value,
                    mainCode: document.getElementById("mainCode").value
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }
    }

    function runCodeDiagnostics() {
        try {
            let res = getIframe().contentWindow.getDiagnostics({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value,
                    mainCode: document.getElementById("mainCode").value,
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }
    }


    function runDefinition() {
        try {
            let res = getIframe().contentWindow.getDefinition({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value,
                    mainCode: document.getElementById("mainCode").value,
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }
    }

    function runInlayHint() {
        try {
            let res = getIframe().contentWindow.getInlayHints({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value,
                    mainCode: document.getElementById("mainCode").value,
                }
            })
            console.log(res)
        } catch (err) {
            console.error(err)
        }
    }

    function runCompletion() {
        try {
            let res = getIframe().contentWindow.getCompletionItems({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value,
                    line: Number(document.getElementById("line").value),
                    column: Number(document.getElementById("column").value),
                    mainCode: document.getElementById("mainCode").value,
                }
            })
            console.log(res)
        } catch (e) {
            console.error(e)
        }
    }

    function runTokenDetail() {
        try {
            let res = getIframe().contentWindow.getTokenDetail({
                in: {
                    name: "test.spx",
                    code: document.getElementById("codeInput").value,
                    line: Number(document.getElementById("line").value),
                    pkgPath: "github.com/goplus/spx",
                    token: document.getElementById("token").value,
                    mainCode: document.getElementById("mainCode").value,
                }
            })
            console.log(res)
        } catch (e) {
            console.error(e)
        }
    }

    function runTokensDetail() {
        try {
            let res = getIframe().contentWindow.getTokensDetail({
                in: {
                    tokens: [
                        {
                            name:"step",
                            pkgPath:"github.com/goplus/spx"
                        },{
                            name:"play",
                            pkgPath:"github.com/goplus/spx"
                        },{
                            name:"onStart",
                            pkgPath:"github.com/goplus/spx"
                        },
                    ]
                }
            })
            console.log(res)
        } catch (e) {
            console.error(e)
        }
    }

</script>

</body>
</html>
