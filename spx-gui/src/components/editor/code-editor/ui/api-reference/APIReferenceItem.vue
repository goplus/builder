<script setup lang="ts">
import { UITooltip } from '@/components/ui'
import { selection2Range } from '../../common'
import DefinitionOverviewWrapper from '../definition/DefinitionOverviewWrapper.vue'
import DefinitionDetailWrapper from '../definition/DefinitionDetailWrapper.vue'
import MarkdownView from '../markdown/MarkdownView.vue'
import { ChatExplainKind, builtInCommandCopilotExplain } from '../code-editor-ui'
import { useCodeEditorUICtx } from '../CodeEditorUI.vue'
import type { APIReferenceItem } from '.'

const props = defineProps<{
  item: APIReferenceItem
}>()

const codeEditorCtx = useCodeEditorUICtx()

function handleInsert() {
  const startPosition = { line: 1, column: 1 }
  let range = { start: startPosition, end: startPosition }
  if (codeEditorCtx.ui.selection != null) {
    range = selection2Range(codeEditorCtx.ui.selection)
  }
  // TODO: Optimize inserting logic with inline context. For example:
  // * If no space before cursor, insert a space before inserting snippet.
  // * If current line isn't empty, insert a new line before inserting snippet for kind Command or Listen.
  codeEditorCtx.ui.insertSnippet(props.item.insertText, range)
  codeEditorCtx.ui.editor.focus()
}

function handleExplain() {
  codeEditorCtx.ui.executeCommand(builtInCommandCopilotExplain, {
    kind: ChatExplainKind.Definition,
    overview: props.item.overview,
    definition: props.item.definition
  })
}
</script>

<template>
  <li class="api-reference-item" @click="handleInsert">
    <DefinitionOverviewWrapper class="overview" :kind="item.kind">{{ item.overview }}</DefinitionOverviewWrapper>
    <DefinitionDetailWrapper>
      <MarkdownView v-bind="item.detail" />
    </DefinitionDetailWrapper>
    <UITooltip>
      <template #trigger>
        <button class="explain-btn" type="button" @click.stop="handleExplain">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M8.79243 6.98251C8.79525 6.96872 8.81496 6.96872 8.81778 6.98251C8.96412 7.69849 9.52365 8.25803 10.2396 8.40437C10.2534 8.40719 10.2534 8.4269 10.2396 8.42972C9.52365 8.57606 8.96412 9.13559 8.81778 9.85157C8.81496 9.86537 8.79525 9.86537 8.79243 9.85157C8.64609 9.13559 8.08656 8.57606 7.37058 8.42972C7.35678 8.4269 7.35678 8.40719 7.37058 8.40437C8.08656 8.25803 8.64609 7.69849 8.79243 6.98251Z"
              stroke="#FAA135"
              stroke-width="0.75"
            />
            <path
              d="M5.93488 2.60136C5.73395 2.65159 5.61179 2.85519 5.66203 3.05611C5.71226 3.25703 5.91586 3.37919 6.11678 3.32896L5.93488 2.60136ZM5.24828 10.0085L5.32554 9.64153H5.32554L5.24828 10.0085ZM3.37958 9.61508L3.45684 9.24812L3.37958 9.61508ZM9.49907 6.06514C9.49907 6.27224 9.66697 6.44014 9.87407 6.44014C10.0812 6.44014 10.2491 6.27224 10.2491 6.06514H9.49907ZM6.9048 10.2803C7.10746 10.2377 7.23717 10.0388 7.1945 9.83613C7.15184 9.63346 6.95296 9.50376 6.75029 9.54642L6.9048 10.2803ZM6.37579 10.0085L6.29854 9.64153L6.29854 9.64153L6.37579 10.0085ZM5.67025 10.0838L5.70134 9.71008H5.70133L5.67025 10.0838ZM5.95383 10.0838L5.92274 9.71008H5.92274L5.95383 10.0838ZM1.8558 8.74132L1.51173 8.89045H1.51173L1.8558 8.74132ZM2.2911 9.27781L2.07428 9.58377H2.07429L2.2911 9.27781ZM8.9701 2.42046L8.85937 2.77874V2.77874L8.9701 2.42046ZM9.68842 2.98131L10.0091 2.78698V2.78698L9.68842 2.98131ZM1.75067 3.75621L2.12548 3.76837L1.75067 3.75621ZM3.27618 2.92141C3.47885 2.96408 3.67773 2.83437 3.72039 2.63171C3.76306 2.42904 3.63335 2.23016 3.43069 2.1875L3.27618 2.92141ZM3.25617 2.53467L3.19085 2.90393H3.19085L3.25617 2.53467ZM5.65083 4.39344C5.65083 4.60055 5.81872 4.76844 6.02583 4.76844C6.23294 4.76844 6.40083 4.60055 6.40083 4.39344H5.65083ZM5.46052 2.49746L5.67026 2.1866L5.46052 2.49746ZM4.79379 2.04762L4.58405 2.35848L4.79379 2.04762ZM3.86006 8.60181L3.94883 8.23747L3.94883 8.23747L3.86006 8.60181ZM3.98482 8.63221L3.89605 8.99655L3.89605 8.99655L3.98482 8.63221ZM5.3834 10.2708C5.46272 10.4621 5.68211 10.5529 5.87343 10.4736C6.06474 10.3943 6.15554 10.1749 6.07622 9.98356L5.3834 10.2708ZM2.125 7.6067V3.85547H1.375V7.6067H2.125ZM6.11678 3.32896L7.41485 3.00445L7.23295 2.27684L5.93488 2.60136L6.11678 3.32896ZM5.32554 9.64153L3.45684 9.24812L3.30233 9.98203L5.17103 10.3754L5.32554 9.64153ZM9.49907 4.63176V6.06514H10.2491V4.63176H9.49907ZM6.75029 9.54642L6.29854 9.64153L6.45305 10.3754L6.9048 10.2803L6.75029 9.54642ZM5.17103 10.3754C5.37279 10.4179 5.50431 10.4463 5.63916 10.4575L5.70133 9.71008C5.62371 9.70363 5.54474 9.68768 5.32554 9.64153L5.17103 10.3754ZM6.29854 9.64153C6.07934 9.68768 6.00037 9.70363 5.92274 9.71008L5.98492 10.4575C6.11977 10.4463 6.25128 10.4179 6.45305 10.3754L6.29854 9.64153ZM5.63916 10.4575C5.75421 10.4671 5.86986 10.4671 5.98492 10.4575L5.92274 9.71008C5.84907 9.71621 5.77501 9.71621 5.70134 9.71008L5.63916 10.4575ZM1.375 7.6067C1.375 7.89805 1.37476 8.13681 1.38924 8.33275C1.40408 8.5334 1.43563 8.71489 1.51173 8.89045L2.19987 8.59219C2.17016 8.52366 2.14882 8.43467 2.1372 8.27747C2.12524 8.11554 2.125 7.90903 2.125 7.6067H1.375ZM3.45684 9.24812C3.16099 9.18584 2.95896 9.14306 2.80298 9.09799C2.65153 9.05424 2.56886 9.01502 2.50791 8.97184L2.07429 9.58377C2.2304 9.6944 2.40149 9.76267 2.59479 9.81852C2.78355 9.87306 3.01723 9.92201 3.30233 9.98203L3.45684 9.24812ZM1.51173 8.89045C1.63231 9.16866 1.82689 9.40846 2.07428 9.58377L2.50791 8.97184C2.37244 8.87584 2.2659 8.74453 2.19987 8.59219L1.51173 8.89045ZM7.41485 3.00445C7.85616 2.89412 8.16327 2.8177 8.40315 2.77979C8.64026 2.74232 8.76817 2.75055 8.85937 2.77874L9.08083 2.06218C8.82973 1.98458 8.56918 1.99424 8.28608 2.03898C8.00574 2.08328 7.6609 2.16985 7.23295 2.27684L7.41485 3.00445ZM10.2491 4.63176C10.2491 4.19063 10.2494 3.83509 10.2244 3.55239C10.1992 3.26689 10.1453 3.01177 10.0091 2.78698L9.36769 3.17563C9.41716 3.25727 9.45617 3.37937 9.47733 3.61848C9.49873 3.86039 9.49907 4.17687 9.49907 4.63176H10.2491ZM8.85937 2.77874C9.07168 2.84436 9.25254 2.98557 9.36769 3.17563L10.0091 2.78698C9.79885 2.4399 9.46856 2.18202 9.08083 2.06218L8.85937 2.77874ZM2.125 3.85547C2.125 3.79999 2.12505 3.78151 2.12548 3.76837L1.37587 3.74405C1.37495 3.7725 1.375 3.80634 1.375 3.85547H2.125ZM3.43069 2.1875C3.38261 2.17738 3.34951 2.17036 3.32148 2.1654L3.19085 2.90393C3.20379 2.90622 3.22188 2.90998 3.27618 2.92141L3.43069 2.1875ZM2.12548 3.76837C2.1434 3.21599 2.64662 2.80767 3.19085 2.90393L3.32148 2.1654C2.3276 1.9896 1.4086 2.73527 1.37587 3.74405L2.12548 3.76837ZM6.40083 4.39344V3.56081H5.65083V4.39344H6.40083ZM5.67026 2.1866L5.00353 1.73675L4.58405 2.35848L5.25079 2.80832L5.67026 2.1866ZM3.08533 2.75652V8.093H3.83533V2.75652H3.08533ZM3.77129 8.96615L3.89605 8.99655L4.07359 8.26786L3.94883 8.23747L3.77129 8.96615ZM3.89605 8.99655C4.56661 9.15992 5.11908 9.63324 5.3834 10.2708L6.07622 9.98356C5.72033 9.12513 4.97646 8.48784 4.07359 8.26786L3.89605 8.99655ZM3.08533 8.093C3.08533 8.50739 3.36868 8.86806 3.77129 8.96615L3.94883 8.23747C3.88221 8.22124 3.83533 8.16156 3.83533 8.093H3.08533ZM5.00353 1.73675C4.18649 1.1855 3.08533 1.7709 3.08533 2.75652H3.83533C3.83533 2.37181 4.26514 2.14331 4.58405 2.35848L5.00353 1.73675ZM6.40083 3.56081C6.40083 3.00979 6.12704 2.49478 5.67026 2.1866L5.25079 2.80832C5.50091 2.97708 5.65083 3.25908 5.65083 3.56081H6.40083Z"
              fill="#57606A"
            />
          </svg>
        </button>
      </template>
      {{
        $t({
          en: 'Explain',
          zh: '解释'
        })
      }}
    </UITooltip>
  </li>
</template>

<style lang="scss" scoped>
.api-reference-item {
  padding: 6px;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: stretch;
  gap: 4px;
  border-radius: var(--ui-border-radius-1);
  transition: 0.2s;
  cursor: pointer;

  &:hover {
    background-color: var(--ui-color-grey-300);

    .explain-btn {
      visibility: visible;
    }
  }
}

.overview {
  display: flex;
  align-items: start;
  font-size: 13px;
  line-height: 20px;
  word-break: break-all;
  color: var(--ui-color-title);
}

.explain-btn {
  position: absolute;
  right: 6px;
  top: 6px;
  padding: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  border: 1px solid var(--ui-color-grey-500);
  background-color: var(--ui-color-grey-100);
  transition: 0.2s;
  cursor: pointer;
  visibility: hidden;

  &:hover {
    background-color: var(--ui-color-grey-400);
    border-color: var(--ui-color-grey-400);
  }
}
</style>
