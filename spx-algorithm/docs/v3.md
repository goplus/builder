# OpenCLIP 功能说明文档

## 简介

本项目基于 [OpenCLIP](https://github.com/mlfoundations/open_clip) 实现了一个图像搜索服务，能够通过自然语言描述来搜索和匹配图像。OpenCLIP 是一个开源的 CLIP（Contrastive Language-Image Pre-training）模型实现，能够理解图像和文本之间的语义关系。

## OpenCLIP 核心功能

### 1. 多模态理解
- **文本编码**: 将自然语言文本转换为向量表示
- **图像编码**: 将图像转换为语义向量表示
- **跨模态匹配**: 计算文本和图像之间的语义相似度

### 2. 支持的模型类型
项目中使用的预训练模型：
- `ViT-B-32`: Vision Transformer Base 模型，32x32 patch size
- 预训练数据集: `laion2b_s34b_b79k`（LAION-2B 数据集）

### 3. 图像格式支持
- **常规格式**: PNG, JPG, JPEG, WebP, BMP, TIFF
- **SVG 支持**: 通过 CairoSVG 转换为位图后处理
- **预处理**: 自动调整图像尺寸到 224x224 像素

## 项目中的应用

### 核心服务类: ImageSearchService

位置: `project/app/services/image_search_service.py`

#### 主要功能方法：

1. **模型初始化** (`_load_model`)
```python
# 加载 CLIP 模型和预处理器
model, _, preprocess = open_clip.create_model_and_transforms(
    model_name, pretrained=pretrained
)
tokenizer = open_clip.get_tokenizer(model_name)
```

2. **图像处理** (`_process_image`)
- 支持多种图像格式
- SVG 文件特殊处理（转换为 PNG）
- 统一预处理到标准尺寸

3. **语义搜索** (`search_images`)
- 文本查询编码
- 批量图像编码
- 相似度计算和排序
- 阈值筛选功能


## API 接口

### 1. 健康检查接口 (`/api/health`)
- **方法**: GET
- **功能**: 检查服务状态
- **响应**:
```json
{
  "status": "healthy",
  "service": "image-search-api"
}
```

### 2. 资源目录SVG搜索 (`/api/search/resource`)
- **方法**: POST
- **功能**: 搜索本地AI素材数据库中的SVG文件
- **内容类型**: application/json

#### 请求Body格式:
```json
{
  "text": "dog",                    // 必需：查询文本
  "k": 5,                       // 可选：返回前k张图片，不设置则返回所有结果
  "threshold": 0.25              // 可选：相似度阈值(0-1)，只返回高于此阈值的结果，默认0.0
}
```

#### 响应格式:
```json
{
  "query": "dog",               // 查询文本
  "results_count": 3,           // 结果数量
  "results": [                  // 结果列表，按相似度降序排列
    {
      "rank": 1,                // 排名
      "similarity": 0.2856,     // 相似度分数 (0-1之间)
      "image_path": "/path/to/resource/dog.svg"  // 图片完整路径
    },
    {
      "rank": 2,
      "similarity": 0.2723,
      "image_path": "/path/to/resource/cute.svg"
    },
    {
      "rank": 3,
      "similarity": 0.2689,
      "image_path": "/path/to/resource/animal.svg"
    }
  ]
}
```

#### 参数说明:
- **text**: 查询的自然语言文本，支持中英文(最好是英文)
- **k**: 限制返回结果数量，不设置则返回所有符合条件的结果
- **threshold**: 相似度阈值过滤，只保留相似度 >= threshold 的结果

#### 错误响应格式:
```json
{
  "error": "错误描述",
  "code": "ERROR_CODE"
}
```

常见错误码：
- `INVALID_JSON`: 请求体不是有效JSON
- `MISSING_TEXT_QUERY`: 查询文本为空
- `INVALID_K`: k参数不是正整数
- `INVALID_THRESHOLD`: threshold参数不在0-1范围内
- `RESOURCE_DIR_NOT_FOUND`: resource目录不存在
- `NO_SVG_FILES_FOUND`: 未找到SVG文件
- `INTERNAL_ERROR`: 内部服务器错误

### 3. 使用示例

#### 基础搜索:
```bash
curl -X POST http://localhost:5000/api/search/resource \
  -H "Content-Type: application/json" \
  -d '{"text": "cute dog"}'
```

#### 限制结果数量:
```bash
curl -X POST http://localhost:5000/api/search/resource \
  -H "Content-Type: application/json" \
  -d '{"text": "animal", "k": 3}'
```

#### 使用相似度阈值:
```bash
curl -X POST http://localhost:5000/api/search/resource \
  -H "Content-Type: application/json" \
  -d '{"text": "dog", "k": 5, "threshold": 0.5}'
```

## 技术特性

### 1. 性能优化
- **模型复用**: 服务启动时加载一次，避免重复加载
- **批量处理**: 支持多图像并行编码
- **GPU 加速**: 自动检测并使用 CUDA（如果可用）

### 2. 错误处理
- 图像文件验证
- 格式不支持的优雅降级
- 详细的错误日志记录
- API参数验证和错误响应

### 3. 筛选功能
- **相似度阈值**: 支持设置最低相似度要求
- **结果数量限制**: 支持返回前K个最相似的结果
- **多重筛选**: 可同时使用阈值和数量限制

### 4. 扩展性
- 可配置的模型参数
- 支持不同的预训练权重
- 易于集成新的图像格式


## 配置选项

### 环境变量
- `CLIP_MODEL_NAME`: CLIP 模型名称（默认: ViT-B-32）
- `CLIP_PRETRAINED`: 预训练权重（默认: laion2b_s34b_b79k）

### 支持的模型类型
- `ViT-B-32`: 轻量级，速度快
- `ViT-B-16`: 更高精度
- `ViT-L-14`: 大型模型，最高精度
- `RN50/RN101`: ResNet 架构



## 效果演示

### **模拟数据库样本**

![img](https://biffmzeipku.feishu.cn/space/api/box/stream/download/asynccode/?code=NmM3YjUxZGE4MzBkOGFjNDY0OWYzNjc2NDFjM2EwMDRfR3pPcHI3MlhhSkxUdTVxRjF3MGduYUVaOW9BbWFjUjBfVG9rZW46Q0toRGJ5VjQwb0ptZzl4UHZhVWNscEsybjRkXzE3NTYxNzU3OTQ6MTc1NjE3OTM5NF9WNA)

### **运行结果**

![img](https://biffmzeipku.feishu.cn/space/api/box/stream/download/asynccode/?code=YWU5M2M2NWRmZjhjNWJiYTlhZWYwOTU1NmMzNmE0YTNfaWo0d3dEa0JyeVN2dk0zRnlEOFl4aGRha0NTWGhMOXNfVG9rZW46UHFPS2JvaUR2b2Q0Uld4RVd3a2M1emNyblVmXzE3NTYxNzU3OTQ6MTc1NjE3OTM5NF9WNA)

![img](https://biffmzeipku.feishu.cn/space/api/box/stream/download/asynccode/?code=YzQ5MjYyYTM5ZDc3ODA2MjIxNGIxYTk4NmRiY2I2YjJfQkhlZjFobTlwRzJ2RWtiaXpPdm4zWk9FTWVMVzlHYXlfVG9rZW46UWJ5b2I0V01Yb3k1N2x4RlJaRWNtRmt6bkxoXzE3NTYxNzU3OTQ6MTc1NjE3OTM5NF9WNA)

![img](https://biffmzeipku.feishu.cn/space/api/box/stream/download/asynccode/?code=MzJhYjE5MzMzYjI3ZDBjNGJlMWZkOWVmMmVhNDc4ZDlfY2pmdDlPQXVlR1RoTXJ3VjhCblV5UVlVblJrMm1uTjFfVG9rZW46Um9YYmJpeTIxb2VMUjZ4S1IyMWNyakR0blBoXzE3NTYxNzU3OTQ6MTc1NjE3OTM5NF9WNA)