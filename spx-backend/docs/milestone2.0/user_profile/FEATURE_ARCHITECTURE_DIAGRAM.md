# SPX Builder 功能架构图：生图 + 推荐 + 用户画像预加载

## 整体架构概览

```

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                API 网关层                                           │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                            YAP 路由层                                       │   │
│  │                                                                             │   │
│  │  现有API端点                           新增API端点                          │   │
│  │  ┌─────────────────────┐              ┌─────────────────────────────┐       │   │
│  │  │ POST /image/svg     │              │ GET  /user/profile          │       │   │
│  │  │ POST /images/recommend│            │ GET  /user/preload-images   │       │   │
│  │  │ GET  /themes        │              │ POST /user/feedback         │       │   │
│  │  │ GET  /assets/list   │              │ GET  /user/behavior-stats   │       │   │
│  │  └─────────────────────┘              └─────────────────────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                               中间件层                                      │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │   │
│  │  │    认证      │  │    授权      │  │   限流       │  │   日志       │        │   │
│  │  │  (Casdoor)  │  │  (Authz)    │  │  (Redis)    │  │  (Logger)   │        │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               Controller 层                                        │
│                                                                                     │
│ ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│ │                              现有Controllers                                   │ │
│ │                                                                                 │ │
│ │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐  │ │
│ │  │ ImageRecommendCtrl  │    │    SVGGenCtrl       │    │   ThemeCtrl         │  │ │
│ │  │                     │    │                     │    │                     │  │ │
│ │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │    │ • 主题配置管理       │  │ │
│ │  │ │ RecommendImages │ │    │ │   GenerateSVG   │ │    │ • Prompt增强模板    │  │ │
│ │  │ │                 │ │    │ │                 │ │    │ • 主题样式定义       │  │ │
│ │  │ │ 1.调用算法服务   │ │    │ │ 1.选择Provider  │ │    └─────────────────────┘  │ │
│ │  │ │ 2.数据库匹配    │ │    │ │ 2.构建Prompt    │ │                             │ │
│ │  │ │ 3.AI生成补充    │ │    │ │ 3.调用AI接口    │ │                             │ │
│ │  │ │ 4.结果排序      │ │◄───┼─┤ 4.质量检查      │ │                             │ │
│ │  │ └─────────────────┘ │    │ │ 5.存储结果      │ │                             │ │
│ │  └─────────────────────┘    │ └─────────────────┘ │                             │ │
│ │                             └─────────────────────┘                             │ │
│ └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                           │
│                                    集成调用                                         │
│                                         ▼                                           │
│ ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│ │                              新增Controllers                                   │ │
│ │                                                                                 │ │
│ │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐  │ │
│ │  │ UserProfileCtrl     │    │   PreloadCtrl       │    │  BehaviorCtrl       │  │ │
│ │  │                     │    │                     │    │                     │  │ │
│ │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │    │ ┌─────────────────┐ │  │ │
│ │  │ │ GetUserProfile  │ │    │ │ GetPreloadImages│ │    │ │ RecordBehavior  │ │  │ │
│ │  │ │                 │ │    │ │                 │ │    │ │                 │ │  │ │
│ │  │ │ 1.画像查询      │ │    │ │ 1.检查缓存      │ │    │ │ 1.行为验证      │ │  │ │
│ │  │ │ 2.偏好计算      │ │    │ │ 2.图库匹配      │ │    │ │ 2.数据存储      │ │  │ │
│ │  │ │ 3.分群判断      │ │    │ │ 3.个性化排序    │ │    │ │ 3.画像更新触发  │ │  │ │
│ │  │ │ 4.统计更新      │ │    │ │ 4.缓存更新      │ │    │ │ 4.异步处理      │ │  │ │
│ │  │ └─────────────────┘ │    │ └─────────────────┘ │    │ └─────────────────┘ │  │ │
│ │  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘  │ │
│ └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                Service 层                                          │
│                                                                                     │
│ ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│ │                               现有Services                                     │ │
│ │                                                                                 │ │
│ │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐  │ │
│ │  │ AlgorithmService    │    │   SVGGenService     │    │   ThemeService      │  │ │
│ │  │                     │    │                     │    │                     │  │ │
│ │  │ • spx-algorithm调用 │    │ • OpenAI Provider   │    │ • 主题配置管理       │  │ │
│ │  │ • 语义搜索          │    │ • Recraft Provider  │    │ • Prompt模板        │  │ │
│ │  │ • 向量相似度        │    │ • SVGIO Provider    │    │ • 风格定义          │  │ │
│ │  │ • 结果过滤          │    │ • 质量评估          │    └─────────────────────┘  │ │
│ │  └─────────────────────┘    │ • 并发控制          │                             │ │
│ │                             └─────────────────────┘                             │ │
│ └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                           │
│                                   服务协作                                         │
│                                         ▼                                           │
│ ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│ │                               新增Services                                     │ │
│ │                                                                                 │ │
│ │  ┌─────────────────────┐    ┌─────────────────────┐                             │ │
│ │  │ ProfileService      │    │ PreloadMatchService │                             │ │
│ │  │                     │    │                     │                             │ │
│ │  │ • 画像CRUD操作      │     │ • 图库向量搜索      │    │ 
│ │  │ • 偏好权重计算      │    │ • 相似度算法        │    │ 
│ │  │ • 用户分群算法      │    │ • 个性化评分        │    │ 
│ │  │ • 行为分析处理      │    │ • 结果排序优化      │    │ 
│ │  └─────────────────────┘    └─────────────────────┘                             │ │
│ │                                                                                 │ │
│ │┌─────────────────────┐  │ │
│ ││ AnalyticsService    │  │ │
│ ││                     │  │ │
│ ││ • 统计数据计算       │  │ │
│ ││ • 性能监控          │  │ │
│ ││ • A/B测试分析       │  │ │
│ ││                    │  │ │
│ │└─────────────────────┘  │ │
│ └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                Model 层                                            │
│                                                                                     │
│ ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│ │                               现有Models                                       │ │
│ │                                                                                 │ │
│ │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐  │ │
│ │  │    AIResource       │    │       User          │    │      Label          │  │ │
│ │  │                     │    │                     │    │                     │  │ │
│ │  │ • ID, URL, Path     │    │ • 用户基础信息      │    │ • 标签定义          │  │ │
│ │  │ • Theme, Provider   │    │ • 认证凭据          │    │ • 分类体系          │  │ │
│ │  │ • Labels, Stats     │    │ • 项目关联          │    │ • 使用统计          │  │ │
│ │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │    └─────────────────────┘  │ │
│ │  │ │ + personalization│ │    │ │ + profile_id    │ │                             │ │
│ │  │ │   _score        │ │    │ │ + user_group    │ │                             │ │
│ │  │ │ + usage_count   │ │    │ │ + last_active   │ │                             │ │
│ │  │ └─────────────────┘ │    │ └─────────────────┘ │                             │ │
│ │  └─────────────────────┘    └─────────────────────┘                             │ │
│ └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                           │
│                                  扩展集成                                          │
│                                         ▼                                           │
│ ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│ │                               新增Models                                       │ │
│ │                                                                                 │ │
│ │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐  │ │
│ │  │   UserProfile       │    │   UserBehavior      │    │   PreloadCache      │  │ │
│ │  │                     │    │                     │    │                     │  │ │
│ │  │ • user_id (FK)      │    │ • user_id (FK)      │    │ • user_id (FK)      │  │ │
│ │  │ • theme_preferences │    │ • behavior_type     │    │ • cache_key         │  │ │
│ │  │ • provider_scores   │    │ • query_text        │    │ • cached_resources  │  │ │
│ │  │ • user_group        │    │ • theme, provider   │    │ • expires_at        │  │ │
│ │  │ • behavior_stats    │    │ • rating, success   │    │ • hit_count         │  │ │
│ │  │ • confidence_score  │    │ • timestamp         │    │ • last_hit_at       │  │ │
│ │  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘  │ │
│ └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               外部服务依赖                                          │
│                                                                                     │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐      │
│  │  spx-algorithm      │    │     AI Providers    │    │   认证授权服务      │      │
│  │                     │    │                     │    │                     │      │
│  │ • 语义搜索服务      │    │ • OpenAI API        │    │ • Casdoor认证       │      │
│  │ • 向量数据库        │    │ • Recraft API       │    │ • JWT token验证     │      │
│  │ • 相似度计算        │    │ • SVGIO API         │    │ • 权限控制          │      │
│  │ 🔗 个性化增强       │    │ 🔗 智能Provider选择  │    │ 🔗 用户画像关联     │      │
│  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 功能模块交互流程图

### 1. 用户画像构建流程

```
┌─────────────┐    用户行为    ┌─────────────┐    数据处理    ┌─────────────┐
│  前端操作    │─────────────►│ BehaviorCtrl │─────────────►│ProfileService│
│             │              │             │              │             │
│ • 搜索图片  │              │ • 行为记录   │              │ • 偏好计算   │
│ • 下载资源  │              │ • 数据验证   │              │ • 权重更新   │
│ • 评分反馈  │              │ • 异步处理   │              │ • 分群判断   │
└─────────────┘              └─────────────┘              └─────────────┘
                                                                   │
                                                              画像更新
                                                                   ▼
┌─────────────┐    画像查询    ┌─────────────┐    数据存储    ┌─────────────┐
│ UserProfile │◄──────────────│PreloadCtrl  │◄──────────────│UserProfile  │
│   Model     │               │             │               │   Table     │
│             │               │ • 画像获取   │               │             │
│ • 主题偏好  │               │ • 匹配算法   │               │ • 偏好权重  │
│ • 分群信息  │               │ • 缓存管理   │               │ • 统计数据  │
│ • 统计数据  │               │ • 结果优化   │               │ • 时间戳    │
└─────────────┘               └─────────────┘               └─────────────┘
```

### 2. 预加载图片流程

```
┌─────────────┐    请求预加载   ┌─────────────┐       
│  前端界面    │──────────────►│ PreloadCtrl │
│             │               │             │              
│ • 页面初始化 │               │ • 用户识别   │              
│ • 刷新请求  │               │ • 画像获取   │               
│ • 手动更新  │               │ • 参数验证   │              
└─────────────┘               └─────────────┘              
                                     │                                                     
                                     ▼                              
┌─────────────┐    图库匹配    ┌─────────────┐                     
│PreloadMatch │◄──────────────│ ProfileSrv  │                     
│  Service    │               │             │                     
│             │               │ • 画像分析   │                     
│ • 向量搜索  │               │ • 偏好提取   │                     
│ • 相似度计算│               │ • 分群信息   │                     
│ • 个性化评分│               │ • 历史行为   │                     
│ • 结果排序  │               └─────────────┘                     
└─────────────┘                                                   
       │                                                          
    匹配结果                                                   
       ▼                                                          
┌─────────────┐                ┌─────────────┐
│ 个性化结果   │──────────────►│   响应结果   │
│             │               │             │
│ • 图片列表  │               │ • 图片数据  │
│ • 匹配评分  │               │ • 个性化信息│
│ • 推荐原因  │               │ • 缓存状态  │
│ • 元数据    │               │ • 性能指标  │
└─────────────┘               └─────────────┘
```

### 3. 增强推荐流程

```
┌─────────────┐    搜索请求    ┌─────────────┐    现有逻辑    ┌─────────────┐
│   用户搜索   │──────────────►│ImageRecommend│──────────────►│Algorithm    │
│             │               │   Ctrl      │               │ Service     │
│ • 输入关键词│               │             │               │             │
│ • 选择主题  │               │ 🔗异步记录行为│               │ • 语义搜索  │
│ • 设置参数  │               │ 🔗获取用户画像│               │ • 向量匹配  │
└─────────────┘               └─────────────┘               │ • 结果过滤  │
                                     │                      └─────────────┘
                               个性化增强                           │
                                     ▼                      算法结果
┌─────────────┐    排序优化    ┌─────────────┐◄──────────────────────┘
│  最终结果    │◄──────────────│ 个性化增强   │
│             │               │             │
│ • 搜索结果  │               │ • 画像匹配评分│
│ • 个性化评分│               │ • 偏好权重计算│
│ • 推荐原因  │               │ • 重排序算法 │
│ • 混合排序  │               │ • 多维度评分 │
└─────────────┘               └─────────────┘
```

### 4. 智能生图流程

```
┌─────────────┐    生图请求    ┌─────────────┐    现有逻辑    ┌─────────────┐
│  生图界面    │──────────────►│  SVGGenCtrl │──────────────►│ SVGGenSrv   │
│             │               │             │               │             │
│ • 输入描述  │               │ 🔗画像优化参数│               │ • Provider  │
│ • 主题选择  │               │ 🔗智能Provider│               │   选择      │
│ • Provider  │               │   选择      │               │ • Prompt    │
└─────────────┘               └─────────────┘               │   构建      │
                                     │                      │ • AI调用    │
                                画像增强                      │ • 质量检查  │
                                     ▼                      └─────────────┘
┌─────────────┐    参数优化    ┌─────────────┐                     │
│  生成结果    │◄──────────────│ 画像增强逻辑 │                 生成结果
│             │               │             │                     │
│ • SVG内容   │               │ • Prompt增强 │                     ▼
│ • 生成信息  │               │ • 主题优化   │              ┌─────────────┐
│ • 个性化    │               │ • Provider   │              │   结果存储   │
│   上下文    │               │   智能选择   │              │             │
└─────────────┘               └─────────────┘              │ • AI资源表  │
       │                                                   │ • 使用统计  │
    行为记录                                                │ • 画像更新  │
       ▼                                                   └─────────────┘
┌─────────────┐
│ 画像反馈更新 │
│             │
│ • 成功率统计│
│ • Provider  │
│   偏好更新  │
│ • 主题偏好  │
│   调整      │
└─────────────┘
```

