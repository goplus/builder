# XBuilder 主题优化系统架构设计文档

## 1. 系统概述

XBuilder主题优化系统是一个智能化的图像推荐和生成系统，通过多维度优化策略提升主题相关图像的推荐准确性和生成质量。

### 1.1 核心目标
- **准确性提升**：通过双路搜索确保推荐结果既语义相关又风格一致
- **质量保证**：多层次prompt优化提升AI生成图像质量
- **完整性保障**：智能补充机制确保返回足够数量的高质量结果
- **用户体验**：主题感知系统确保结果符合用户期望

### 1.2 系统特性
- 🎯 智能prompt分析与优化
- 🔄 双路并发搜索策略
- 🧠 结果融合与智能评分
- 🎨 主题感知AI生成
- 📊 完整的结果追踪与排序

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户请求层                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ HTTP API: /api/images/recommend                             │ │
│  │ Request: {prompt, theme, top_k}                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      控制器层 (Controller)                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ RecommendImages()                                           │ │
│  │ ├─ 参数验证                                                  │ │
│  │ ├─ 主题检测 (Theme != None)                                 │ │
│  │ ├─ 路由选择: dualPathSearch() | singleSemanticSearch()     │ │
│  │ └─ 结果组装与返回                                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                    │
                     ┌──────────────┴──────────────┐
                     ▼                             ▼
┌─────────────────────────────────┐  ┌─────────────────────────────────┐
│        双路搜索策略              │  │        单路语义搜索              │
│  ┌─────────────────────────────┐ │  │  ┌─────────────────────────────┐ │
│  │ dualPathSearch()            │ │  │  │ singleSemanticSearch()      │ │
│  │ ├─ 并发语义搜索 (70%)        │ │  │  │ ├─ 直接语义搜索              │ │
│  │ ├─ 并发主题搜索 (30%)        │ │  │  │ └─ 结果处理                 │ │
│  │ └─ 结果融合与评分            │ │  │  └─────────────────────────────┘ │
│  └─────────────────────────────┘ │  └─────────────────────────────────┘
└─────────────────────────────────┘                   │
                     │                                │
                     └──────────────┬─────────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Prompt优化层                               │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ OptimizePromptWithAnalysis()                                │ │
│  │ ├─ AnalyzePromptType() - 语义分析                           │ │
│  │ ├─ 多层prompt构建                                           │ │
│  │ │  ├─ Base Prompt (用户输入)                                │ │
│  │ │  ├─ Theme Prompt (主题增强)                              │ │
│  │ │  ├─ Quality Prompt (质量要求)                            │ │
│  │ │  ├─ Style Prompt (风格指导)                              │ │
│  │ │  └─ Technical Prompt (技术规范)                          │ │
│  │ └─ GetOptimizedPromptForSearch() - 搜索专用优化             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                    │
                     ┌──────────────┴──────────────┐
                     ▼                             ▼
┌─────────────────────────────────┐  ┌─────────────────────────────────┐
│         搜索服务层               │  │         AI生成服务层             │
│  ┌─────────────────────────────┐ │  │  ┌─────────────────────────────┐ │
│  │ callAlgorithmService()      │ │  │  │ generateAISVGs()            │ │
│  │ ├─ spx-algorithm API调用    │ │  │  │ ├─ 主题感知Provider选择       │ │
│  │ ├─ 语义相似度计算           │ │  │  │ ├─ 并发SVG生成              │ │
│  │ └─ 结果排序                 │ │  │  │ ├─ 质量过滤                 │ │
│  └─────────────────────────────┘ │  │  │ └─ 相似度分配               │ │
└─────────────────────────────────┘  │  └─────────────────────────────┘ │
                                     └─────────────────────────────────┘
                                                    │
                                    ┌───────────────┴───────────────┐
                                    ▼                               ▼
┌─────────────────────────────────┐  ┌─────────────────────────────────┐
│         结果融合层               │  │         数据持久层               │
│  ┌─────────────────────────────┐ │  │  ┌─────────────────────────────┐ │
│  │ fuseSearchResults()         │ │  │  │ MySQL Database              │ │
│  │ ├─ 去重处理                 │ │  │  │ ├─ aiResource表              │ │
│  │ ├─ 主题相关性评分           │ │  │  │ ├─ label表                   │ │
│  │ ├─ 综合评分计算             │ │  │  │ ├─ resource_label表          │ │
│  │ └─ 最终排序                 │ │  │  │ └─ 软删除支持               │ │
│  └─────────────────────────────┘ │  │  └─────────────────────────────┘ │
└─────────────────────────────────┘  └─────────────────────────────────┘
```

### 2.2 核心组件说明

#### 2.2.1 Prompt优化引擎
```go
// 核心结构
type PromptAnalysis struct {
    Type       string   // 内容类型: animal, character, scene, etc.
    Emotion    string   // 情感倾向: cute, serious, happy, etc.
    Complexity string   // 复杂度: simple, medium, complex
    Keywords   []string // 关键词提取
}

// 优化策略
- 语义分析: 识别prompt内容特征
- 分层构建: 基础+主题+质量+风格+技术
- 搜索优化: 语义搜索vs主题搜索的不同策略
```

#### 2.2.2 双路搜索引擎
```go
// 搜索策略
func dualPathSearch(params) {
    // 并发执行
    go semanticSearch(optimizedPrompt_Light)  // 70% 保证相关性
    go themeSearch(optimizedPrompt_Full)      // 30% 保证风格
    
    // 结果融合
    return fuseResults(semanticResults, themeResults)
}
```

#### 2.2.3 结果融合算法
```go
// 评分公式
finalScore = semanticSimilarity * 0.7 + themeRelevance * 0.3

// 主题相关性计算
func calculateThemeRelevance(imagePath, theme) float64 {
    // 基于路径特征、元数据、ML模型等
    // 返回 0.0-1.0 的相关性分数
}
```

## 3. 数据流架构

### 3.1 请求处理流程

```
用户请求 → 参数验证 → 主题检测 → 搜索策略选择
    ↓
Prompt优化 → 双路/单路搜索 → 结果融合 → AI生成补充
    ↓
排序组装 → 返回结果
```

### 3.2 数据结构设计

#### 3.2.1 请求参数
```go
type ImageRecommendParams struct {
    Text  string    `json:"prompt"`           // 用户输入的描述
    TopK  int       `json:"top_k,omitempty"`  // 返回结果数量 (1-50)
    Theme ThemeType `json:"theme,omitempty"`  // 主题类型
}
```

#### 3.2.2 返回结果
```go
type ImageRecommendResult struct {
    Query        string                   `json:"query"`         // 最终使用的查询
    ResultsCount int                      `json:"results_count"` // 结果数量
    Results      []RecommendedImageResult `json:"results"`       // 推荐结果
}

type RecommendedImageResult struct {
    ID         int64   `json:"id"`         // 资源ID
    ImagePath  string  `json:"image_path"` // 图像路径
    Similarity float64 `json:"similarity"` // 相似度分数
    Rank       int     `json:"rank"`       // 排名
    Source     string  `json:"source"`     // 来源: search/generated
}
```

## 4. 性能优化策略

### 4.1 并发处理
- **双路搜索并发**：语义搜索和主题搜索同时执行
- **AI生成并发**：多个SVG同时生成，提升响应速度
- **超时控制**：避免长时间等待影响用户体验

### 4.2 缓存策略
- **Prompt缓存**：相同prompt的优化结果缓存
- **搜索结果缓存**：algorithm service结果缓存
- **AI生成缓存**：避免重复生成相同内容

### 4.3 降级策略
- **搜索降级**：双路搜索失败时降级为单路
- **生成降级**：AI生成失败时返回现有搜索结果
- **主题降级**：主题不支持时使用默认策略

## 5. 扩展性设计

### 5.1 主题扩展
```go
// 新增主题只需扩展以下配置
var ThemePrompts = map[ThemeType]string{
    ThemeNewStyle: "新主题的prompt增强规则",
}

var ThemeProviders = map[ThemeType]svggen.Provider{
    ThemeNewStyle: svggen.ProviderBest,
}
```

### 5.2 算法扩展
- **新搜索算法**：插件化搜索算法接口
- **新评分模型**：可插拔的相关性评分算法
- **新生成Provider**：支持新的AI生成服务

### 5.3 监控与观测
```go
// 关键指标监控
- 搜索成功率
- AI生成成功率  
- 平均响应时间
- 用户满意度评分
- 主题识别准确率
```

## 6. 安全与稳定性

### 6.1 输入验证
- Prompt长度限制 (防止恶意超长输入)
- 主题类型白名单验证
- TopK数量范围控制 (1-50)

### 6.2 错误处理
- 优雅降级机制
- 详细错误日志记录
- 用户友好错误提示

### 6.3 资源保护
- 并发数量限制
- 超时机制保护
- 内存使用监控

## 7. 部署架构

### 7.1 服务依赖
```
spx-backend (主服务)
    ├── spx-algorithm (搜索服务)
    ├── AI Providers (生成服务)
    │   ├── OpenAI
    │   ├── Recraft  
    │   └── SVGIO
    ├── MySQL (数据存储)
    └── Redis (缓存层)
```

### 7.2 配置管理
- 环境变量配置
- 动态配置更新
- 服务发现机制

这个架构设计确保了系统的高性能、可扩展性和用户体验，为XBuilder提供了强大的主题化图像推荐能力。