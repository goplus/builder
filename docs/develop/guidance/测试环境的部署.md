# 测试环境的部署

## 注意

注意，下列所有操作都需要在连上**七牛云内网**之后才能进行。包括服务搭建完成之后也需要连接**七牛内网**才能进行访问！！！

## 1.将builder项目打包成镜像

在builder内部有写好的Dockerfile，只需以此文件执行相关打包命令即可。参考命令：

```
docker buildx build --load -t aslan-spock-register.qiniu.io/goplus/builder-guidance:v1.2 .
```

## 2.将本地打包好的镜像推送到远程

可以推送到：aslan-spock-register.qiniu.io/goplus/builder-xxx:xxx

参考命令：

```
docker push aslan-spock-register.qiniu.io/goplus/builder-guidance:v1.2
```

docker镜像的相关资料：https://yeasy.gitbook.io/docker_practice/image/build

## 3.登录到KubeSphere

利用LDAP进行登录。需要找管理员要一下权限。

## 4.创建服务

进入KubeSphere后，首先点击项目，进入到builder项目。

![进入项目](./assets/进入项目.png)

之后进入应用负载中的服务。

![进入服务](./assets/进入服务.png)

点击创建服务。

![创建服务](./assets/创建服务.png)

之后选择无状态服务。

![无状态服务](./assets/选择无状态服务.png)

设置好名称后点击下一步。

![设置名称](./assets/名称.png)

之后点击添加容器。

![添加容器](./assets/添加容器.png)

输入之前弄好的镜像，并为容器配置名称。

![镜像](./assets/选择镜像以及配置容器名字.png)

之后配置端口。

![镜像](./assets/配置端口.png)

之后选择配置字典（如果需要自定义配置字典可以模仿已有配置字典进行创建）

![添加配置字典](./assets/配置字典.png)

![配置字典](./assets/选择配置字典.png)

添加配置字典的信息。

![配置配置字典](./assets/配置配置字典.png)

之后一直点完成即可。

在上述步骤完成后，会出现服务启动失败的信息，此时请先进入服务下面的工作负载中。然后点击你创建的工作负载去修改YAML文件（如下图）。

![编辑YAML](./assets/编辑yaml.png)

将deFauleMode从420修改为511。

![修改Mode](./assets/修改Mode.png)

将下述图1替换成图2。

![图1](./assets/图1.png)

![图2](./assets/图2.png)

之后就能正常运行了。

## 5.配置域名

进入应用路由。

无需创建，直接在现有的基础上进行修改。

![配置路由](./assets/配置路由.png)

配置的域名采用类似goplus-builder-xxx.jfcs-k8s-qa1.qiniu.io这样的域名即可。域名的配置信息如下，**注意**要选择你已经部署好的服务以及相应的开放端口！

![域名](./assets/域名.png)
